function loadApiKey(){const e=localStorage.getItem("gemini_api_key")||"";$("#geminiApiKey").val(e)}$(document).ready((function(){$("#stunServerCollapse").on("shown.bs.collapse",(()=>{$("#stunToggleIcon").removeClass("fa-chevron-down").addClass("fa-chevron-up")})),$("#stunServerCollapse").on("hidden.bs.collapse",(()=>{$("#stunToggleIcon").removeClass("fa-chevron-up").addClass("fa-chevron-down")})),$("#btn-toggle-back").click((()=>{$("#media-input-group").addClass("d-none"),$("#text-input-group").removeClass("d-none"),$("#chat-file").val("")})),$("#btn-toggle").on("click",(()=>{$("#chat-message").blur(),$("#attachment-menu").toggleClass("d-none")})),$(document).on("click",(e=>{$(e.target).closest("#attachment-menu, #btn-toggle").length||$("#attachment-menu").addClass("d-none")})),$(".attachment-btn").on("click",(function(){const a=$(this).data("type"),i=$("#chat-file");switch(i.removeAttr("accept capture"),a){case"image":i.attr("accept","image/*"),r(a);break;case"camera":i.attr("accept","image/*").attr("capture","environment"),r(a);break;case"video":i.attr("accept","video/*"),r(a);break;case"audio":i.attr("accept","audio/*"),r(a);break;case"doc":i.attr("accept",".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.odt"),r(a);break;case"file":r(a);break;case"record-voice":!function(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return void alert("Media recording not supported on this browser.");navigator.mediaDevices.getUserMedia({audio:!0}).then((a=>{e=new MediaRecorder(a),n=[],e.ondataavailable=e=>{e.data.size&&n.push(e.data)},e.onstop=()=>{clearInterval(t),$("#voiceRecordingTimer").text("00:00"),o=0;g(new Blob(n,{type:"audio/webm"}),"record-voice.webm")},e.start(),$("#voiceRecordingModal").modal("show"),s()})).catch((e=>alert("Microphone access denied or not available")))}();break;case"record-video":c();break;case"location":$("#locationModal").modal("show"),setTimeout((()=>{m?m.invalidateSize():(m=L.map("map").setView([20.5937,78.9629],5),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(m),p=L.marker([20.5937,78.9629],{draggable:!0}).addTo(m),m.on("click",(function(e){v=e.latlng,p.setLatLng(v)})))}),300);break;case"link":const d=prompt("Enter a link to share:");d&&d.startsWith("http")&&function(e){truncateName(e,20);t=e,$("#chat-message").val(t);var t}(d)}$("#attachment-menu").addClass("d-none")}));let e,t,a,n=[],o=0,i=0;function r(e){$("#chat-file").data("attachment-type",e),$("#chat-file").click(),$("#media-input-group").removeClass("d-none"),$("#text-input-group").addClass("d-none")}function s(){t=setInterval((()=>{o++;const e=String(Math.floor(o/60)).padStart(2,"0"),t=String(o%60).padStart(2,"0");$("#voiceRecordingTimer").text(`${e}:${t}`)}),1e3)}function c(){navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then((a=>{e=new MediaRecorder(a),n=[];$("#videoPreview")[0].srcObject=a,$("#videoRecordingModal").modal("show"),e.ondataavailable=e=>{e.data.size&&n.push(e.data)},e.onstop=()=>{clearInterval(t),$("#videoRecordingTimer").text("00:00"),o=0;g(new Blob(n,{type:"video/webm"}),"record-video.webm"),a.getTracks().forEach((e=>e.stop()))},e.start(),s()})).catch((e=>alert("Camera access denied"))):alert("Media recording not supported on this browser.")}$("#stopVoiceRecordingBtn").on("click",(()=>{e&&"recording"===e.state&&(e.stop(),$("#voiceRecordingModal").modal("hide"))})),$("#stopVideoRecordingBtn").on("click",(()=>{e&&"recording"===e.state&&(e.stop(),$("#videoRecordingModal").modal("hide"))}));let d,l=!0;function c(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return void alert("Media recording not supported on this browser.");const t={video:{facingMode:l?"user":"environment"},audio:!0};navigator.mediaDevices.getUserMedia(t).then((t=>{d=t,e=new MediaRecorder(t),n=[];$("#videoPreview")[0].srcObject=t,$("#videoRecordingModal").modal("show"),e.ondataavailable=e=>{e.data.size&&n.push(e.data)},e.onstop=()=>{clearInterval(a),$("#videoRecordingTimer").text("00:00"),i=0;g(new Blob(n,{type:"video/webm"}),"record-video.webm"),d.getTracks().forEach((e=>e.stop()))},e.start(),a=setInterval((()=>{i++;const e=String(Math.floor(i/60)).padStart(2,"0"),t=String(i%60).padStart(2,"0");$("#videoRecordingTimer").text(`${e}:${t}`)}),1e3)})).catch((e=>alert("Camera access denied")))}function g(e,t){const a=new File([e],t,{type:e.type}),n=new DataTransfer;n.items.add(a);const o=$("#chat-file")[0];o.files=n.files,$(o).trigger("change"),$("#media-input-group").removeClass("d-none"),$("#text-input-group").addClass("d-none")}$("#stopVideoRecordingBtn").on("click",(()=>{e&&"recording"===e.state&&(e.stop(),$("#videoRecordingModal").modal("hide"))})),$("#switchCameraBtn").on("click",(()=>{l=!l,d&&d.getTracks().forEach((e=>e.stop())),c()}));let m,p,v=null;$("#btnCurrentLocation").click((()=>{navigator.geolocation.getCurrentPosition((e=>{const{latitude:t,longitude:a}=e.coords;v={lat:t,lng:a},p.setLatLng(v),m.setView(v,15)}),(()=>alert("Unable to get current location")))})),$("#btnSearchLocation").click((()=>{!function(e){if(!e)return;const t=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(e)}`;fetch(t).then((e=>e.json())).then((e=>{if(e&&e.length>0){const t=e[0],a={lat:parseFloat(t.lat),lng:parseFloat(t.lon)};v=a,p.setLatLng(a),m.setView(a,14)}else alert("No location found.")})).catch((()=>alert("Location search failed.")))}($("#location-search").val().trim())})),$("#btnSendLocation").click((()=>{if(!v)return void alert("Select a location first.");const{lat:e,lng:t}=v,a=`https://maps.google.com/?q=${e},${t}`,n=JSON.stringify({type:"location",lat:e,lng:t,url:a,name:truncateName(a,25),messageId:Date.now()});dataChannel&&"open"===dataChannel.readyState&&(dataChannel.send(n),displayMessage("Me",n,!0,"location",null,n.messageId,"sent")),$("#locationModal").modal("hide")})),$("#saveGeminiKeyBtn").click((()=>{const e=$("#geminiApiKey").val().trim();if(!e)return alert("Please enter an API key");localStorage.setItem("gemini_api_key",e),$("#settingAi").modal("hide"),showAlert("Gemini API key saved successfully",!1)})),$("#ai-btn").click((()=>{void 0!==window.autoCheckInterval&&clearInterval(window.autoCheckInterval),$("#ai-btn").addClass("d-none"),$("#login-section").addClass("d-none"),$("#reloadBtn").addClass("d-none"),$("#chat-section").removeClass("d-none"),$("#headerBtnName").html('<i class="fas fa-robot"></i> Jarvis'),$("#btn-toggle").addClass("d-none"),$("#chat-message").val(""),$("#settingBtn").attr("data-bs-target","#settingAi"),$("#delete-all-btn").wrap('<div class="d-flex align-items-center"></div>'),$('<button id="backBtn" class="btn btn-link text-white fs-6 p-0 text-decoration-none fw-bold border-0 me-2"><i class="fas fa-arrow-left"></i></button>').insertBefore("#delete-all-btn").click((()=>{location.reload()})),$("#delete-all-btn").removeAttr("id"),$("#btn-send-text").off("click").on("click",(async()=>{const e=$("#chat-message").val().trim();if(!e)return;displayMessage("You",e,!0,"text",null,Date.now().toString(),"sent"),$("#chat-message").val("");const t=await async function(e){const t=localStorage.getItem("gemini_api_key");if(!t)return"Please set the API key in settings";try{const a=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:`Reply like a friendly human:\n${e}`}]}]})}),n=await a.json();return n?.candidates?.[0]?.content?.parts?.[0]?.text||"ðŸ¤– Sorry, I don't understand."}catch(e){return console.error("Gemini error:",e),"ðŸ¤– Error connecting to Gemini."}}(e);displayMessage("Jarvis",t,!1,"text",null,Date.now().toString(),"delivered")}));if(!localStorage.getItem("gemini_api_key")){new bootstrap.Modal(document.getElementById("settingAi")).show()}}))}));